# Serverless Template — GraphQL + REST

Functionality
-------------
- **Protocols** — GraphQL + REST
- **DBs (Adapters)** — Mongo + Redis 
- **Platforms** — [Serverless.com](https://serverless.com), AWS(several services), [Mongo Cloud](https://www.mongodb.com/cloud/atlas/)
- **Deploys**
  - AWS services directly through [Serverless.com](https://serverless.com)
  - For production deploys for greater speed can either be deployed on:
    - EC2(VM) or another VM provider w/ auto-scaling
    - EKS or any other K8 provider (already auto-scales)

Purpose
-------------
Provides a template for creation of GraphQL(queries, mutations + subscriptions) + REST interfaces

Technology — serverless

Technology — non-serverless
-------------
- REST — Node + Express
- GraphQL — ApolloGraphQL over Express
- Deploys — docker-compose or kubectl(more for deploys)

Technology — serverless
-------------
- REST — AWS Lambda + other services, as needed
- GraphQL — AWS Appsync + AWS Lambda
- Deploys — [Serverless.com](https://serverless.com) + scripts to automate creation of endpoint configs



### Local Development
Local development is done through docker-compose for quick development(serverless).
Deploys through CloudFormation/serverless.com take roughly 2 minutes per deploy and this would be too slow per change 

To setup locally, run:
```shell
chmod u+x setup.sh;
./setup.sh
docker system prune; ##Cleaning up all 
```

Afterwords, the project can just be built & run:
```shell
docker-compose build;
docker-compose up;
```

If, there are issues such as previous images not re-compiling, just re-run the cleanup process:
```shell
./docker-clean;
docker system prune;
./docker-clean;
```

### Deployment (serverless.com)
Get AWS credentials, then setup account on [Serverless.com](https://serverless.com)

The serverless endpoints are deployed by:
```shell
cd services/node/serverless;
./deploy.py --serverless;
```

The deploy URLs will be provided in the terminal output, along with the API key

Afterwards, single deploys can be done through:
```shell
cd services/node/serverless;
./deploy.py --manual
```

### Directory Structure
```shell
services/
  /ingress #local deploy
  /mongo #local deploy
  /node
    /config #app config
    /libs #shared libs
    /models #points to models in /serverless/models
    /routes #routes REST - points to /serverless/routes
    /serverless #routes serverless REST + GraphQL
      .serverless #Generated by serverless.yml config. Do not edit manually
      /config
      /models
        /graphql
          resolvers.js
          schema.graphql
        /mongodb
          index.js (points to models)
      /routes
          graphql.js (points to all generated graphql endpoints)
          graphqlplayground.js
      deploy.py #main deploy file, run with no options to see help
      serverless.yml #main serverless file
        # references generated files created by deploy.py &
        # files in /config 
    /tests
      /postman #contain an example collection & environment for Postman(integration tests)
      /scripts #contains an example Python3 & BASH script
      /unit #contains an example unit test
    /views #contains the pug files needed for showing a default page when there are errors(REST-only)
    .dockerignore #files for Docker not to copy over
    .eslintrc #base eslint config
    .eslintrcGoogle.js #Google extensions to eslint
    .flowconfig #configuration for flow
    .gitignore #files for Git to ignore
    app.js #starting point for execution. Do not alter
    Dockerfile #Dockerfile for Node
    package.json #packages used
    requirements.txt #python packages used (pip install -r requirements.txt)      
clean.py #Cleans docker containers, volumes & images. --help for options. Default: -a -dc DOCKER_COMPOSE_FILENAME
docker-compose.yml
setup.sh
```
